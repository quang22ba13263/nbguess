<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUMBRLE - Multiplayer Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS của bạn giữ nguyên ở đây */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #121213;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            padding: 15px 0;
            text-align: center;
            border-bottom: 1px solid #3a3a3c;
            position: relative;
        }
        
        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #f5b301;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-50%) scale(1.1);
        }
        
        .logo {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: #f5b301;
            margin-bottom: 5px;
        }
        
        .tagline {
            font-size: 1rem;
            color: #888;
        }
        
        main {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .game-section {
            flex: 2;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: #1a1a1b;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .game-info {
            display: flex;
            flex-direction: column;
        }
        
        .game-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #f5b301;
        }
        
        .game-subtitle {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .game-room {
            font-size: 0.9rem;
            padding: 8px 15px;
            background-color: rgba(245, 179, 1, 0.1);
            border-radius: 4px;
            color: #f5b301;
        }
        
        .game-status {
            margin-top: 10px;
        }
        
        .game-content {
            background-color: #1a1a1b;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
        }
        
        .number-range {
            font-size: 1.1rem;
            color: #aaa;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .number-range span {
            color: #f5b301;
            font-weight: 600;
        }
        
        .current-player {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: rgba(245, 179, 1, 0.1);
            border-radius: 4px;
        }
        
        .player-turn {
            color: #f5b301;
            font-weight: 600;
        }
        
        .guess-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .guess-input {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            border-radius: 4px;
            background-color: #2a2a2b;
            border: 1px solid #333;
            color: #fff;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .guess-input:focus {
            outline: none;
            border-color: #f5b301;
        }
        
        .btn {
            background-color: #f5b301;
            color: #121213;
            border: none;
            padding: 12px 25px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .btn:hover {
            background-color: #ffcc33;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background-color: #444;
            color: #777;
            cursor: not-allowed;
            transform: none;
        }
        
        .game-history {
            flex: 1;
            margin-top: 20px;
            overflow-y: auto;
            background-color: #212122;
            border-radius: 4px;
            padding: 10px;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-bottom: 1px solid #333;
        }
        
        .history-player {
            font-weight: 600;
            margin-right: 10px;
            color: #f5b301;
        }
        
        .history-guess {
            font-weight: 600;
            margin-right: 10px;
        }
        
        .history-result {
            font-size: 0.9rem;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .result-higher {
            background-color: #b59f3b;
            color: #121213;
        }
        
        .result-lower {
            background-color: #538d4e;
            color: #121213;
        }
        
        .result-correct {
            background-color: #f5b301;
            color: #121213;
        }
        
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .players-list {
            background-color: #1a1a1b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .players-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f5b301;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px solid #333;
        }
        
        .player-item:last-child {
            border-bottom: none;
        }
        
        .player-avatar {
            width: 30px;
            height: 30px;
            background-color: #444;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #fff;
        }
        
        .player-name {
            flex: 1;
        }
        
        .player-score {
            font-weight: 600;
            color: #f5b301;
        }
        
        .chat-container {
            background-color: #1a1a1b;
            border-radius: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            font-weight: 600;
            color: #f5b301;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 10px;
            border-radius: 4px;
            max-width: 80%;
            word-break: break-word;
        }
        
        .message-system {
            align-self: center;
            background-color: #212122;
            color: #888;
            font-size: 0.9rem;
            max-width: 100%;
            text-align: center;
        }
        
        .message-sender {
            align-self: flex-end;
            background-color: #f5b301;
            color: #121213;
        }
        
        .message-receiver {
            align-self: flex-start;
            background-color: #2a2a2b;
        }
        
        .message-info {
            font-size: 0.8rem;
            color: #777;
            margin-top: 5px;
        }
        
        .message-sender .message-info {
            color: rgba(0, 0, 0, 0.6);
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #333;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 4px;
            background-color: #2a2a2b;
            border: 1px solid #333;
            color: #fff;
        }
        
        .chat-input input:focus {
            outline: none;
            border-color: #f5b301;
        }
        
        .chat-input button {
            background-color: #f5b301;
            color: #121213;
            border: none;
            padding: 0 15px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .game-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .btn-leave {
            background-color: transparent;
            border: 2px solid #f5b301;
            color: #f5b301;
        }
        
        .btn-leave:hover {
            background-color: rgba(245, 179, 1, 0.1);
        }
        
        footer {
            padding: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            border-top: 1px solid #3a3a3c;
        }
        
        @media (max-width: 900px) {
            main {
                flex-direction: column;
            }
            
            .game-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .game-room {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="numberguess.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="logo">NUMBRLE</div>
        <div class="tagline">Multiplayer Mode</div>
    </header>
    
    <main>
        <div class="game-section">
            <div class="game-header">
                <div class="game-info">
                    <div class="game-title">Multiplayer Number Guessing</div>
                    <div class="game-subtitle">Take turns guessing the number</div>
                </div>
                <div class="game-room">Room Code: <strong id="room-code">Waiting...</strong></div>
            </div>
            
            <div class="game-content">
                <div class="number-range">
                    Guess a number between <span id="min-range">1</span> and <span id="max-range">100</span>
                </div>
                
                <div class="current-player">
                    Current Turn: <span class="player-turn" id="current-player-turn">Waiting...</span>
                    <div class="game-status" id="game-status-message">Waiting for game to start...</div>
                </div>
                
                <div class="guess-form">
                    <input type="number" class="guess-input" id="guess-input" min="1" max="100" placeholder="Enter your guess..." disabled>
                    <button class="btn" id="guess-btn" disabled>SUBMIT GUESS</button>
                </div>
                
                <div class="game-history" id="game-history">
                    <!-- Game history items will be added here by JavaScript -->
                </div>
                
                <div class="game-actions">
                    <button class="btn btn-leave" id="leave-btn">LEAVE GAME</button>
                </div>
            </div>
        </div>
        
        <div class="chat-section">
            <div class="players-list" id="players-list-container">
                <div class="players-title">
                    <i class="fas fa-users"></i> Players (<span id="current-players-count">0</span>/<span id="max-players-count">0</span>)
                </div>
                <!-- Player items will be added here by JavaScript -->
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <i class="fas fa-comment-alt"></i> Game Chat
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <!-- Chat messages will be added here by JavaScript -->
                </div>
                
                <div class="chat-input">
                    <input type="text" placeholder="Type a message..." id="chat-input">
                    <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <p>© 2023 NUMBRLE - The Ultimate Number Guessing Game</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const guessInput = document.getElementById('guess-input');
            const guessBtn = document.getElementById('guess-btn');
            const gameHistory = document.getElementById('game-history');
            const leaveBtn = document.getElementById('leave-btn');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const chatMessages = document.getElementById('chat-messages');
            const roomCodeDisplay = document.getElementById('room-code');
            const currentPlayerTurnDisplay = document.getElementById('current-player-turn');
            const gameStatusMessageDisplay = document.getElementById('game-status-message');
            const playersListContainer = document.getElementById('players-list-container'); // Parent for player items
            const currentPlayersCountDisplay = document.getElementById('current-players-count');
            const maxPlayersCountDisplay = document.getElementById('max-players-count');
            
            // Lấy username từ localStorage hoặc API (nếu có đăng nhập)
            // Đây là ví dụ, bạn cần điều chỉnh để lấy thông tin người dùng thật
            const currentUser = {
                id: 'user-' + Math.random().toString(36).substr(2, 9), // Tạo ID tạm thời
                name: localStorage.getItem('guestNickname') || 'Player' + Math.floor(Math.random() * 1000),
                // avatar: 'P' // hoặc URL avatar
            };
            // Hiển thị tên người dùng hiện tại (nếu có chỗ nào đó bạn muốn hiển thị "You")
            // Ví dụ: document.getElementById('my-username-display').textContent = currentUser.name;


            // // WEBSOCKET START
            let socket = null;

            function connectWebSocket() {
                // Lấy URL cơ sở của trang, thay http bằng ws hoặc https bằng wss
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host; // Sẽ là nbguessing.glitch.me (hoặc localhost khi dev)
                const wsUrl = `${protocol}//${host}/ws_python`; // Kết nối qua proxy path

                console.log("Attempting to connect to WebSocket at:", wsUrl);
                addSystemMessageToChat("Connecting to server...");

                socket = new WebSocket(wsUrl);

                socket.onopen = () => {
                    console.log('WebSocket connection established to Python server!');
                    addSystemMessageToChat("Connected to server! Joining game...");
                    // Gửi thông tin người chơi khi kết nối thành công
                    // Bạn có thể gửi thông tin phòng (nếu có) hoặc yêu cầu tạo/vào phòng
                    socket.send(JSON.stringify({ 
                        type: "JOIN_REQUEST", 
                        payload: { 
                            userId: currentUser.id, 
                            username: currentUser.name 
                            // roomCode: "SOME_ROOM_CODE" // Nếu người dùng nhập mã phòng
                        } 
                    }));
                };

                socket.onmessage = (event) => {
                    console.log('Message from Python server: ', event.data);
                    try {
                        const messageData = JSON.parse(event.data);
                        handleServerMessage(messageData);
                    } catch (e) {
                        console.error("Error parsing message from server:", e);
                        addSystemMessageToChat("Received malformed message from server.");
                    }
                };

                socket.onclose = (event) => {
                    if (event.wasClean) {
                        console.log(`WebSocket connection closed cleanly, code=${event.code} reason=${event.reason}`);
                        addSystemMessageToChat(`Disconnected: ${event.reason || 'Connection closed cleanly'}`);
                    } else {
                        console.error('WebSocket connection died');
                        addSystemMessageToChat('Connection lost. Attempting to reconnect in 5 seconds...');
                        // Tùy chọn: Thử kết nối lại sau một khoảng thời gian
                        setTimeout(connectWebSocket, 5000);
                    }
                    // Vô hiệu hóa các nút khi mất kết nối
                    guessBtn.disabled = true;
                    guessInput.disabled = true;
                    guessInput.placeholder = "Disconnected...";
                    sendBtn.disabled = true;
                    chatInput.disabled = true;
                };

                socket.onerror = (error) => {
                    console.error('WebSocket Error: ', error);
                    addSystemMessageToChat('WebSocket error. Check console for details.');
                    // Vô hiệu hóa các nút khi có lỗi
                    guessBtn.disabled = true;
                    guessInput.disabled = true;
                    sendBtn.disabled = true;
                    chatInput.disabled = true;
                };
            }

            function handleServerMessage(message) {
                switch (message.type) {
                    case 'JOIN_SUCCESS': // Server xác nhận tham gia phòng thành công
                        roomCodeDisplay.textContent = message.payload.roomCode;
                        addSystemMessageToChat(`Joined room: ${message.payload.roomCode}. Waiting for players...`);
                        updatePlayersList(message.payload.players);
                        updateGameInfo(message.payload.gameInfo); // Min/max range, current turn if game started
                        break;
                    case 'PLAYER_JOINED': // Người chơi khác tham gia
                        addSystemMessageToChat(`${message.payload.username} joined the game.`);
                        updatePlayersList(message.payload.players);
                        break;
                    case 'PLAYER_LEFT': // Người chơi khác rời đi
                        addSystemMessageToChat(`${message.payload.username} left the game.`);
                        updatePlayersList(message.payload.players);
                        break;
                    case 'GAME_START': // Game bắt đầu
                        addSystemMessageToGameHistory(`Game started! Guess between ${message.payload.range.min} and ${message.payload.range.max}.`);
                        document.getElementById('min-range').textContent = message.payload.range.min;
                        document.getElementById('max-range').textContent = message.payload.range.max;
                        updateTurn(message.payload.currentPlayer);
                        break;
                    case 'GAME_UPDATE': // Cập nhật trạng thái game (ví dụ: sau một lượt đoán)
                        addGuessToHistory(message.payload.lastGuess.player, message.payload.lastGuess.guess, message.payload.lastGuess.result);
                        updateTurn(message.payload.currentPlayer);
                        gameStatusMessageDisplay.textContent = message.payload.feedback || ''; // "Higher", "Lower" etc.
                        break;
                    case 'GAME_OVER': // Game kết thúc
                        addSystemMessageToGameHistory(`Game Over! ${message.payload.winner} wins! The number was ${message.payload.secretNumber}.`);
                        addSystemMessageToChat(`${message.payload.winner} is the winner!`);
                        guessBtn.disabled = true;
                        guessInput.disabled = true;
                        guessInput.placeholder = "Game Over!";
                        currentPlayerTurnDisplay.textContent = "Game Over";
                        break;
                    case 'CHAT_MESSAGE': // Nhận tin nhắn chat
                        addChatMessage(message.payload.senderName, message.payload.text, false); // false vì đây là tin nhắn nhận được
                        break;
                    case 'ERROR': // Lỗi từ server
                        console.error("Server error:", message.payload.message);
                        addSystemMessageToChat(`Error: ${message.payload.message}`);
                        alert(`Server Error: ${message.payload.message}`);
                        break;
                    case 'YOUR_TURN': // Thông báo đến lượt của bạn
                        addSystemMessageToGameHistory("It's your turn!");
                        gameStatusMessageDisplay.textContent = "Your turn to guess!";
                        guessInput.disabled = false;
                        guessBtn.disabled = false;
                        guessInput.placeholder = "Enter your guess...";
                        guessInput.focus();
                        break;
                    case 'WAIT_FOR_TURN': // Thông báo chờ lượt
                        gameStatusMessageDisplay.textContent = `Waiting for ${message.payload.currentPlayerName}'s turn...`;
                        guessInput.disabled = true;
                        guessBtn.disabled = true;
                        guessInput.placeholder = "Waiting for other player...";
                        break;
                    default:
                        console.log("Received unhandled message type:", message.type);
                }
            }

            function updateGameInfo(gameInfo) {
                if (gameInfo) {
                    if(gameInfo.range) {
                        document.getElementById('min-range').textContent = gameInfo.range.min;
                        document.getElementById('max-range').textContent = gameInfo.range.max;
                    }
                    if(gameInfo.currentPlayer) {
                         updateTurn(gameInfo.currentPlayer);
                    }
                }
            }

            function updatePlayersList(players) {
                // Xóa danh sách người chơi hiện tại trước khi render lại
                // Giữ lại thẻ title
                const titleElement = playersListContainer.querySelector('.players-title');
                playersListContainer.innerHTML = ''; 
                if (titleElement) playersListContainer.appendChild(titleElement);

                currentPlayersCountDisplay.textContent = players.length;
                // Giả sử max_players được gửi từ server hoặc cố định
                // maxPlayersCountDisplay.textContent = message.payload.maxPlayers || 4; 

                players.forEach(player => {
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-item';
                    
                    const avatarInitial = player.name ? player.name.substring(0, 1).toUpperCase() : 'P';
                    let displayName = player.name;
                    if (player.id === currentUser.id) {
                        displayName += " (You)";
                    }

                    playerItem.innerHTML = `
                        <div class="player-avatar">${avatarInitial}</div>
                        <div class="player-name">${displayName}</div>
                        <div class="player-score">${player.score || 0} pts</div>
                    `;
                    playersListContainer.appendChild(playerItem);
                });
            }

            function updateTurn(currentPlayerInfo) {
                 if (!currentPlayerInfo) return;
                 const turnPlayerName = currentPlayerInfo.name || 'Unknown Player';
                 currentPlayerTurnDisplay.textContent = turnPlayerName;

                if (currentPlayerInfo.id === currentUser.id) {
                    handleServerMessage({type: 'YOUR_TURN'}); // Kích hoạt lượt của client này
                } else {
                    handleServerMessage({type: 'WAIT_FOR_TURN', payload: {currentPlayerName: turnPlayerName}});
                }
            }
            
            // // WEBSOCKET END


            // Mock data and initial state - Sẽ được thay thế bởi dữ liệu từ WebSocket
            // const isMyTurn = true; // Sẽ được quản lý bởi server
            
            // Set up initial state - Sẽ được quản lý bởi server
            // if (!isMyTurn) {
            //     guessBtn.disabled = true;
            //     guessInput.disabled = true;
            //     guessInput.placeholder = "Waiting for other player's turn...";
            // }
            
            // Handle guess submission
            guessBtn.addEventListener('click', function() {
                const guessValue = guessInput.value.trim();
                
                if (!guessValue || isNaN(guessValue)) {
                    alert('Please enter a valid number.');
                    return;
                }
                const guessNumber = parseInt(guessValue);
                const minRange = parseInt(document.getElementById('min-range').textContent);
                const maxRange = parseInt(document.getElementById('max-range').textContent);

                if (guessNumber < minRange || guessNumber > maxRange) {
                    alert(`Please enter a number between ${minRange} and ${maxRange}`);
                    return;
                }
                
                // Gửi guess đến server qua WebSocket
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: "PLAYER_GUESS",
                        payload: {
                            guess: guessNumber
                        }
                    }));
                    // Vô hiệu hóa input sau khi gửi, server sẽ kích hoạt lại nếu đến lượt
                    guessInput.value = '';
                    // guessBtn.disabled = true; // Server sẽ quyết định
                    // guessInput.disabled = true; // Server sẽ quyết định
                    // guessInput.placeholder = "Waiting for result...";
                } else {
                    addSystemMessageToChat("Not connected to server. Cannot send guess.");
                }
            });
            
            // Không cần hàm simulateOtherPlayerGuess nữa, server sẽ gửi cập nhật

            function addGuessToHistory(playerName, guess, result) {
                let resultClass = '';
                let resultText = result.toUpperCase(); // HIGHER, LOWER, CORRECT

                if (resultText === 'HIGHER') resultClass = 'result-higher';
                else if (resultText === 'LOWER') resultClass = 'result-lower';
                else if (resultText === 'CORRECT') resultClass = 'result-correct';
                
                const historyEntry = document.createElement('div');
                historyEntry.className = 'history-item';
                historyEntry.innerHTML = `
                    <span class="history-player">${playerName}:</span>
                    <span class="history-guess">${guess}</span>
                    <span class="history-result ${resultClass}">${resultText}</span>
                `;
                
                gameHistory.insertBefore(historyEntry, gameHistory.firstChild);
            }

            function addSystemMessageToGameHistory(messageText) {
                const historyEntry = document.createElement('div');
                historyEntry.className = 'history-item'; // Hoặc một class khác cho system message
                historyEntry.innerHTML = `
                    <span class="history-player">System:</span>
                    <span>${messageText}</span>
                `;
                gameHistory.insertBefore(historyEntry, gameHistory.firstChild);
            }
            
            // Handle chat submission
            sendBtn.addEventListener('click', sendChatMessageViaSocket);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessageViaSocket();
                }
            });
            
            function sendChatMessageViaSocket() {
                const messageText = chatInput.value.trim();
                if (!messageText) return;

                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: "CHAT_MESSAGE",
                        payload: {
                            text: messageText
                            // senderId và senderName sẽ được server thêm vào dựa trên kết nối WebSocket
                        }
                    }));
                    // Hiển thị tin nhắn của chính mình ngay lập tức (optional, server cũng sẽ gửi lại)
                    // addChatMessage(currentUser.name, messageText, true); 
                    chatInput.value = '';
                } else {
                     addSystemMessageToChat("Not connected to server. Cannot send message.");
                }
            }

            function addChatMessage(senderName, messageText, isSender) {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12; // convert 0 to 12
                const timeString = `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                
                const messageElement = document.createElement('div');
                // Xác định class dựa trên người gửi là client hiện tại hay người khác
                // Nếu isSender là true (tin nhắn của chính mình) hoặc senderName trùng với currentUser.name
                if (isSender || senderName === currentUser.name) {
                     messageElement.className = 'message message-sender';
                     senderName = "You"; // Hiển thị "You" cho tin nhắn của chính mình
                } else {
                     messageElement.className = 'message message-receiver';
                }

                messageElement.innerHTML = `
                    <div class="message-content">${escapeHTML(messageText)}</div>
                    <div class="message-info">${escapeHTML(senderName)} • ${timeString}</div>
                `;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addSystemMessageToChat(messageText) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message message-system';
                messageElement.textContent = escapeHTML(messageText);
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Utility to escape HTML to prevent XSS
            function escapeHTML(str) {
                const div = document.createElement('div');
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
            }
            
            // Handle leave game button
            leaveBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to leave the game?')) {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ type: "LEAVE_GAME" }));
                        socket.close(); // Chủ động đóng kết nối
                    }
                    window.location.href = 'numberguess.html';
                }
            });

            // Khởi tạo kết nối WebSocket khi trang được tải
            connectWebSocket();

        });
    </script>
</body>
</html>